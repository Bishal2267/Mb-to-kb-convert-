<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free online tool to convert and compress images to a specific target file size (MB or KB) without significant quality loss.">
    <meta name="keywords" content="image converter, MB to KB, image optimizer, reduce image size, compress image, target size, no quality loss, online image tool, image compressor">
    <meta name="author" content="ImageOpti">
    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.imageopti.com/">
    <meta property="og:title" content="ImageOpti - Target Size Image Converter">
    <meta property="og:description" content="Free online tool to convert and compress images to a specific target file size (MB or KB) without significant quality loss.">
    <meta property="og:image" content="https://placehold.co/1200x630/000000/FFFFFF?text=ImageOpti">
    <!-- Twitter Meta Tags -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.imageopti.com/">
    <meta property="twitter:title" content="ImageOpti - Target Size Image Converter">
    <meta property="twitter:description" content="Free online tool to convert and compress images to a specific target file size (MB or KB) without significant quality loss.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/000000/FFFFFF?text=ImageOpti">

    <title>ImageOpti - Target Size Converter</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for social icons and the hamburger menu icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Homebrew (custom) icon for mobile devices (e.g., when adding to home screen) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://placehold.co/180x180/2563EB/FFFFFF?text=IO">
    <link rel="icon" type="image/png" sizes="32x32" href="https://placehold.co/32x32/2563EB/FFFFFF?text=IO">
    <link rel="icon" type="image/png" sizes="16x16" href="https://placehold.co/16x16/2563EB/FFFFFF?text=IO">

    <style>
        /* Ensures the body takes full viewport height and main content expands */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Main content area takes up remaining space */
        main {
            flex: 1;
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #7a7a7a;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg py-4 px-6 md:px-10 rounded-b-xl">
        <div class="container mx-auto flex justify-between items-center">
            <!-- Site Name and Logo - Clickable to return Home -->
            <a href="#" id="home-link-header" class="flex items-center space-x-2 text-2xl font-bold tracking-tight transform hover:scale-105 transition-transform duration-200">
                <i class="fas fa-image text-3xl"></i>
                <span>ImageOpti</span>
            </a>

            <!-- Mobile Menu Button (Hamburger Icon) - Visible only on small screens -->
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300">
                <i class="fas fa-bars text-2xl"></i>
            </button>

            <!-- Navigation Links (Desktop) - Hidden on small screens -->
            <nav class="hidden md:flex space-x-8 font-medium">
                <a href="#" id="home-link-nav" class="hover:text-blue-200 transition duration-300 transform hover:scale-105">Home</a>
                <a href="#" id="about-link" class="hover:text-blue-200 transition duration-300 transform hover:scale-105">About Us</a>
                <a href="#" id="contact-link" class="hover:text-blue-200 transition duration-300 transform hover:scale-105">Contact Us</a>
                <a href="#" id="terms-link" class="hover:text-blue-200 transition duration-300 transform hover:scale-105">Terms & Conditions</a>
            </nav>
        </div>

        <!-- Mobile Navigation Menu - Toggles visibility via JavaScript -->
        <nav id="mobile-menu" class="hidden md:hidden mt-4 space-y-3 px-4 pb-2 bg-blue-700 rounded-lg shadow-md">
            <a href="#" id="home-link-mobile" class="block py-2 px-3 rounded-md hover:bg-blue-600 transition duration-300">Home</a>
            <a href="#" id="about-link-mobile" class="block py-2 px-3 rounded-md hover:bg-blue-600 transition duration-300">About Us</a>
            <a href="#" id="contact-link-mobile" class="block py-2 px-3 rounded-md hover:bg-blue-600 transition duration-300">Contact Us</a>
            <a href="#" id="terms-link-mobile" class="block py-2 px-3 rounded-md hover:bg-blue-600 transition duration-300">Terms & Conditions</a>
        </nav>
    </header>

    <!-- Main Content Area - This div will be dynamically updated by JavaScript -->
    <main id="app-content" class="container mx-auto p-6 md:p-10 flex-grow"></main>

    <!-- Footer Section -->
    <footer class="bg-gray-900 text-gray-300 py-8 px-6 md:px-10 mt-10 rounded-t-xl">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Section 1: Site Name and Logo -->
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <a href="#" id="home-link-footer" class="flex items-center space-x-2 text-2xl font-bold tracking-tight text-white mb-2 transform hover:scale-105 transition-transform duration-200">
                    <i class="fas fa-image text-3xl"></i>
                    <span>ImageOpti</span>
                </a>
                <p class="text-sm">Your go-to online tool for image optimization.</p>
            </div>

            <!-- Section 2: Quick Links / Pages -->
            <div class="text-center md:text-left">
                <h3 class="text-lg font-semibold text-white mb-4">Quick Links</h3>
                <ul class="space-y-2">
                    <li><a href="#" id="about-link-footer" class="hover:text-blue-400 transition duration-300 text-sm">About Us</a></li>
                    <li><a href="#" id="contact-link-footer" class="hover:text-blue-400 transition duration-300 text-sm">Contact Us</a></li>
                    <li><a href="#" id="terms-link-footer" class="hover:text-blue-400 transition duration-300 text-sm">Terms & Conditions</a></li>
                </ul>
            </div>

            <!-- Section 3: Social Icons -->
            <div class="text-center md:text-right">
                <h3 class="text-lg font-semibold text-white mb-4">Connect With Us</h3>
                <div class="flex justify-center md:justify-end space-x-4">
                    <a href="https://facebook.com/imageopti" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-white transition duration-300 text-2xl"><i class="fab fa-facebook-square"></i></a>
                    <a href="https://twitter.com/imageopti" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-white transition duration-300 text-2xl"><i class="fab fa-twitter-square"></i></a>
                    <a href="https://instagram.com/imageopti" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-white transition duration-300 text-2xl"><i class="fab fa-instagram-square"></i></a>
                    <a href="https://linkedin.com/company/imageopti" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-white transition duration-300 text-2xl"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <!-- Copyright Notice -->
        <div class="text-center text-sm mt-8 pt-6 border-t border-gray-700">
            &copy; <span id="current-year"></span> ImageOpti. All rights reserved.
        </div>
    </footer>

    <script>
        // Ensure the DOM is fully loaded before running scripts
        document.addEventListener('DOMContentLoaded', () => {
            const appContent = document.getElementById('app-content');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const currentYearSpan = document.getElementById('current-year');

            if (currentYearSpan) {
                currentYearSpan.textContent = new Date().getFullYear();
            }

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            /**
             * Displays a message to the user within a designated message box.
             * @param {string} message - The message text to display.
             * @param {boolean} isError - True for red styling, false for green.
             */
            function showMessageBox(message, isError = true) {
                const messageBox = document.getElementById('messageBox');
                if (messageBox) {
                    messageBox.textContent = message;
                    messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
                    if (isError) {
                        messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    } else {
                        messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    }
                    messageBox.classList.remove('hidden');
                }
            }

            /**
             * Hides the message box.
             */
            function hideMessageBox() {
                const messageBox = document.getElementById('messageBox');
                if (messageBox) {
                    messageBox.classList.add('hidden');
                }
            }

            /**
             * Loads and displays content for a specific page.
             * @param {string} pageName - The identifier for the page to load.
             */
            function loadPage(pageName) {
                let content = '';
                switch (pageName) {
                    case 'home':
                        content = `
                            <section class="text-center py-12 px-4">
                                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6 leading-tight">Image Converter</h1>
                                <p class="text-lg md:text-xl text-gray-700 max-w-2xl mx-auto mb-10">
                                    Convert your image to a specific target size (in KB or MB) with minimal quality loss.
                                </p>
                                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200 max-w-3xl mx-auto">
                                    <div class="mb-6">
                                        <label for="imageUpload" class="block text-gray-700 text-lg font-semibold mb-3">Upload your image</label>
                                        <input type="file" id="imageUpload" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 cursor-pointer transition duration-200">
                                    </div>

                                    <div class="mb-6">
                                        <label for="targetSizeValue" class="block text-gray-700 text-lg font-semibold mb-3">
                                            Target File Size
                                        </label>
                                        <div class="flex space-x-2">
                                            <input type="number" id="targetSizeValue" min="1" value="500" class="flex-1 w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="e.g., 500">
                                            <select id="targetSizeUnit" class="w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                                <option value="kb">KB</option>
                                                <option value="mb">MB</option>
                                            </select>
                                        </div>
                                        <p class="text-sm text-gray-500 mt-2">Enter the size you want your image to be. We will aim for this size or a little less.</p>
                                    </div>

                                    <button id="convertButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg text-xl font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform hover:scale-105">
                                        Convert Image
                                    </button>

                                    <div id="loadingIndicator" class="mt-6 hidden">
                                        <div class="flex items-center justify-center">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                                            <span class="ml-3 text-blue-600 font-medium">Processing image...</span>
                                        </div>
                                    </div>

                                    <div id="outputArea" class="mt-8 pt-6 border-t border-gray-200 hidden">
                                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Conversion Result</h2>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                            <div>
                                                <p class="text-gray-600 font-medium">Original Size:</p>
                                                <p id="originalSize" class="text-lg font-semibold text-gray-800">-</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600 font-medium">Converted Size:</p>
                                                <p id="convertedSize" class="text-lg font-semibold text-green-600">-</p>
                                            </div>
                                        </div>
                                        <div class="mt-6 flex flex-col items-center">
                                            <p class="text-gray-700 mb-3">Your optimized image is ready!</p>
                                            <a id="downloadLink" class="inline-block bg-green-600 text-white py-3 px-8 rounded-lg text-lg font-semibold shadow-md hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 ease-in-out transform hover:scale-105" download="optimized_image.webp">
                                                Download Optimized Image
                                            </a>
                                            <!-- Hidden canvas for image processing -->
                                            <canvas id="imageCanvas" class="hidden"></canvas>
                                            <!-- Message box for user feedback -->
                                            <div id="messageBox" class="mt-4 p-3 rounded-lg hidden w-full text-sm"></div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `;
                        break;
                    case 'about':
                        content = `
                            <section class="py-12 px-4 max-w-4xl mx-auto">
                                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6 text-center">About ImageOpti</h1>
                                <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                                    Welcome to ImageOpti, your dedicated online platform for efficient image optimization.
                                    In today's digital world, image file sizes can significantly impact website loading
                                    speeds, email attachment limits, and overall user experience. We created ImageOpti
                                    to provide a simple, fast, and effective solution for reducing image file sizes
                                    to a **specific target size** without compromising visual quality.
                                </p>
                                <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                                    Our primary goal is to help you convert your images from megabytes (MB) to kilobytes (KB)
                                    while maintaining the best possible visual integrity. We leverage advanced compression
                                    techniques and efficient image formats like WebP to achieve impressive file size reductions,
                                    making your images web-friendly and easy to share.
                                </p>
                                <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                                    At ImageOpti, we believe that powerful tools should be accessible to everyone.
                                    That's why our converter is completely free to use, requires no registration,
                                    and works directly in your browser. Your images are processed client-side,
                                    meaning they are never uploaded to our servers, ensuring your privacy and security.
                                </p>
                                <p class="text-lg text-gray-700 leading-relaxed">
                                    Thank you for choosing ImageOpti. We're continuously working to improve our service
                                    and add more features to meet your image optimization needs.
                                </p>
                            </section>
                        `;
                        break;
                    case 'contact':
                        content = `
                            <section class="py-12 px-4 max-w-xl mx-auto">
                                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6 text-center">Contact Us</h1>
                                <p class="text-lg text-gray-700 mb-8 text-center">
                                    Have questions, feedback, or need support? We're here to help!
                                </p>
                                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
                                    <form class="space-y-6">
                                        <div>
                                            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                                            <input type="text" id="name" name="name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                                        </div>
                                        <div>
                                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Your Email</label>
                                            <input type="email" id="email" name="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="your.email@example.com">
                                        </div>
                                        <div>
                                            <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Your Message</label>
                                            <textarea id="message" name="message" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us how we can help you..."></textarea>
                                        </div>
                                        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg text-xl font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform hover:scale-105">
                                            Send Message
                                        </button>
                                    </form>
                                    <p class="text-center text-gray-500 text-sm mt-6">
                                        Alternatively, you can reach us directly at: <a href="mailto:support@imageopti.com" class="text-blue-600 hover:underline">support@imageopti.com</a>
                                    </p>
                                </div>
                            </section>
                        `;
                        break;
                    case 'terms':
                        content = `
                            <section class="py-12 px-4 max-w-4xl mx-auto">
                                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6 text-center">Terms & Conditions</h1>
                                <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-4">1. Acceptance of Terms</h2>
                                    <p>
                                        By accessing and using ImageOpti (the "Service"), you accept and agree to be bound by the terms and provisions of this agreement.
                                        If you do not agree to abide by the above, please do not use this Service.
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">2. Description of Service</h2>
                                    <p>
                                        ImageOpti provides an online tool for converting image files to a specific target size (MB or KB). This service primarily utilizes client-side browser capabilities. The Service is provided "as is" and "as available".
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">3. Privacy Policy</h2>
                                    <p>
                                        We value your privacy. All image processing occurs directly in your browser.
                                        No images are uploaded to our servers, ensuring your data remains private and secure.
                                        We do not collect, store, or share any personal information or uploaded image data.
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">4. User Conduct</h2>
                                    <p>
                                        You agree to use the Service only for lawful purposes and in a way that does not infringe
                                        the rights of, restrict or inhibit anyone else's use and enjoyment of the Service.
                                        Prohibited behavior includes harassing or causing distress or inconvenience to any other user,
                                        transmitting obscene or offensive content or disrupting the normal flow of dialogue within the Service.
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">5. Disclaimer of Warranties</h2>
                                    <p>
                                        The Service is provided without any warranties or guarantees, express or implied.
                                        We do not warrant that the Service will be uninterrupted, timely, secure, or error-free.
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">6. Limitation of Liability</h2>
                                    <p>
                                        In no event shall ImageOpti be liable for any direct, indirect, incidental, special,
                                        consequential, or exemplary damages, including but not limited to, damages for loss of profits,
                                        goodwill, data or other intangible losses resulting from the use or the inability to use the Service.
                                    </p>

                                    <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">7. Changes to Terms</h2>
                                    <p>
                                        We reserve the right to modify these Terms at any time. Your continued use of the Service
                                        after any such changes constitutes your acceptance of the new Terms.
                                    </p>
                                </div>
                            </section>
                        `;
                        break;
                    default:
                        content = `<section class="text-center py-12 px-4"><h1 class="text-4xl font-bold text-gray-900">Page Not Found</h1><p class="text-lg text-gray-700 mt-4">The page you are looking for does not exist.</p></section>`;
                }
                appContent.innerHTML = content;

                if (!mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }

                if (pageName === 'home') {
                    initializeConverter();
                }
            }

            // --- Event Listeners for Navigation Links ---
            document.getElementById('home-link-header')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('home'); });
            document.getElementById('home-link-nav')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('home'); });
            document.getElementById('about-link')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('about'); });
            document.getElementById('contact-link')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('contact'); });
            document.getElementById('terms-link')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('terms'); });
            document.getElementById('home-link-mobile')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('home'); });
            document.getElementById('about-link-mobile')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('about'); });
            document.getElementById('contact-link-mobile')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('contact'); });
            document.getElementById('terms-link-mobile')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('terms'); });
            document.getElementById('home-link-footer')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('home'); });
            document.getElementById('about-link-footer')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('about'); });
            document.getElementById('contact-link-footer')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('contact'); });
            document.getElementById('terms-link-footer')?.addEventListener('click', (e) => { e.preventDefault(); loadPage('terms'); });

            // Load the home page content when the website first loads
            loadPage('home');

            // --- Image Converter Core Logic (updated) ---
            function initializeConverter() {
                const imageUpload = document.getElementById('imageUpload');
                const targetSizeValueInput = document.getElementById('targetSizeValue');
                const targetSizeUnitSelect = document.getElementById('targetSizeUnit');
                const convertButton = document.getElementById('convertButton');
                const loadingIndicator = document.getElementById('loadingIndicator');
                const outputArea = document.getElementById('outputArea');
                const originalSizeSpan = document.getElementById('originalSize');
                const convertedSizeSpan = document.getElementById('convertedSize');
                const downloadLink = document.getElementById('downloadLink');
                const imageCanvas = document.getElementById('imageCanvas');
                const ctx = imageCanvas ? imageCanvas.getContext('2d') : null;

                // Utility function to convert canvas to a Blob with a specific quality
                // and wrap it in a Promise for easier async/await usage.
                function toBlobAsync(canvas, format = 'image/webp', quality = 1.0) {
                    return new Promise((resolve) => {
                        canvas.toBlob(resolve, format, quality);
                    });
                }

                if (convertButton && imageUpload && ctx) {
                    convertButton.addEventListener('click', async () => {
                        const file = imageUpload.files[0];
                        if (!file) {
                            showMessageBox("Please select an image file first.", true);
                            return;
                        }

                        const targetValue = parseFloat(targetSizeValueInput.value);
                        if (isNaN(targetValue) || targetValue <= 0) {
                            showMessageBox("Please enter a valid target size (a number greater than 0).", true);
                            return;
                        }

                        // Convert target size to bytes for comparison
                        const targetUnit = targetSizeUnitSelect.value;
                        const targetSizeInBytes = targetUnit === 'mb' ? targetValue * 1024 * 1024 : targetValue * 1024;

                        hideMessageBox();
                        loadingIndicator.classList.remove('hidden');
                        outputArea.classList.add('hidden');
                        downloadLink.removeAttribute('href');
                        downloadLink.setAttribute('download', `optimized_image_target_${targetValue}${targetUnit}.webp`);

                        const reader = new FileReader();

                        reader.onload = async (e) => {
                            const img = new Image();
                            img.onload = async () => {
                                imageCanvas.width = img.width;
                                imageCanvas.height = img.height;
                                ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                                ctx.drawImage(img, 0, 0);

                                const originalSizeBytes = file.size;
                                const originalSizeKB = (originalSizeBytes / 1024).toFixed(2);
                                const originalSizeMB = (originalSizeBytes / (1024 * 1024)).toFixed(2);
                                originalSizeSpan.textContent = `${originalSizeMB} MB (${originalSizeKB} KB)`;

                                // Check if the original image is already smaller
                                if (originalSizeBytes <= targetSizeInBytes) {
                                    const blob = await toBlobAsync(imageCanvas, 'image/webp', 1.0);
                                    if (blob) {
                                        const url = URL.createObjectURL(blob);
                                        downloadLink.href = url;
                                        convertedSizeSpan.textContent = `${(blob.size / 1024).toFixed(2)} KB`;
                                        showMessageBox("Image is already smaller than the target size. Download the original optimized version.", false);
                                        loadingIndicator.classList.add('hidden');
                                        outputArea.classList.remove('hidden');
                                    } else {
                                        showMessageBox("An error occurred during conversion.", true);
                                        loadingIndicator.classList.add('hidden');
                                    }
                                    return;
                                }

                                let quality = 0.9;
                                const minQuality = 0.1;
                                const qualityStep = 0.05;
                                let convertedBlob = null;

                                // Iterative compression loop
                                while (quality >= minQuality) {
                                    convertedBlob = await toBlobAsync(imageCanvas, 'image/webp', quality);
                                    if (!convertedBlob) break; // Exit loop if conversion fails

                                    if (convertedBlob.size <= targetSizeInBytes) {
                                        // Found a suitable quality level
                                        break;
                                    }
                                    // Reduce quality for the next iteration
                                    quality -= qualityStep;
                                }

                                if (convertedBlob) {
                                    if (convertedBlob.size > targetSizeInBytes) {
                                        // Even at the lowest quality, the image is too large
                                        showMessageBox(`Could not reach the target size of ${targetValue} ${targetUnit.toUpperCase()} while maintaining some quality. The converted image is the smallest we could make it.`, false);
                                    } else {
                                        showMessageBox("Image converted successfully!", false);
                                    }

                                    const url = URL.createObjectURL(convertedBlob);
                                    downloadLink.href = url;
                                    convertedSizeSpan.textContent = `${(convertedBlob.size / 1024).toFixed(2)} KB`;

                                    loadingIndicator.classList.add('hidden');
                                    outputArea.classList.remove('hidden');

                                } else {
                                    showMessageBox("Failed to convert image. Please try again.", true);
                                    loadingIndicator.classList.add('hidden');
                                }
                            };
                            img.onerror = () => {
                                showMessageBox("Could not load image. Please ensure it's a valid image file.", true);
                                loadingIndicator.classList.add('hidden');
                            };
                            img.src = e.target.result;
                        };
                        reader.onerror = () => {
                            showMessageBox("Failed to read file. Make sure it's an image.", true);
                            loadingIndicator.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }
        });
    </script>
</body>
</html>

